
var CommonPlatform={defaultPageName:null,endpoints:["/magellan-ws/resources/navigationentries/standalone"],initialize:function(options){if(typeof(options)=='object'){if(options.defaultPageName&&typeof(options.defaultPageName)=='string'){CommonPlatform.defaultPageName=options.defaultPageName;}
if(options.handler&&typeof(options.handler)=='function'){Messenger.initialize(options.handler);}
if(options.standalone&&typeof(options.standalone)=='boolean'&&options.standalone==true){CommonContext.standalone=options.standalone;ChannelManager.commtype="standalone";Authenticator.authenticateByCookies()
if(options.header&&typeof(options.header)=='boolean'&&options.header==true||options.header==null){$('body').prepend(Header().prepend(InstitutionalBranding()).prepend(UserControls()));ChannelManager.initialize();Theme.load();HelpManager.initialize();if(options.globalNav&&typeof(options.globalNav)=='boolean'&&options.globalNav==true||options.globalNav==null){addNavigationControls();}}
ContentManager.initialize();if(options.footer&&typeof(options.footer)=='boolean'&&options.footer==true||options.footer==null){Footer.initialize();OpenItems.initialize();}
Localization.initialize();ResourceManager.addResourceBundle("common-platform");ContentManager.calculateContentHeight();}else{Bootstraper.add(function(){$('body').prepend(Header().prepend(InstitutionalBranding()).prepend(UserControls()).prepend(SearchBox()));addNavigationControls();var l=XMLHelper.getElementData(XMLHelper.getFirstChild(CommonContext.udcIdentity,"PersonName"),"LegalName");var f=XMLHelper.getElementData(XMLHelper.getFirstChild(CommonContext.udcIdentity,"PersonName"),"GivenName");$('.userIdentityText').text(f+" "+l);});Bootstraper.add(Theme.load);Bootstraper.add(WorkspaceManager.initialize);Bootstraper.add(FragmentManager.initialize);Bootstraper.add(ChannelManager.initialize);Bootstraper.add(Navigation.initialize);Bootstraper.add(Footer.initialize);Bootstraper.add(OpenItems.initialize);Bootstraper.add(ContentManager.initialize);Bootstraper.add(HelpManager.initialize);Bootstraper.add(Localization.initialize);EventDispatcher.addEventListener(Authenticator.events.authorizationComplete,Bootstraper.go);Authenticator.authorizeByUDCID();ResourceManager.addResourceBundle("common-platform");}}}}
var Authenticator={endpoints:{index:-1,authorize:[]},events:{authorizationComplete:"authorizationComplete"},authenticateByCookies:function(){var username=CookieManager.get("username");if(username){CommonContext.user=username;}},authorizeByUDCID:function(){var udcid=CookieManager.get("udcid");Authenticator.endpoints.index+=1;if(udcid){ServiceManager.get(Authenticator.endpoints.authorize[Authenticator.endpoints.index].replace(":udcid",udcid),function(xmldoc){if(!xmldoc){return;}
if(xmldoc.status){if(xmldoc.status==404||xmldoc.status==500){Authenticator.authorizeByUDCID();return;}}
CommonContext.user=XMLHelper.getElementData(xmldoc,"LogonID");CommonContext.pidm=XMLHelper.getElementData(xmldoc,"BannerInternalID");CommonContext.udcid=XMLHelper.getElementData(xmldoc,"UDCIdentifier");CommonContext.udcIdentity=XMLHelper.getFirstChild(xmldoc,"UDCIdentity");var roles=XMLHelper.getChildren(xmldoc,"institutionrole");var r="";var first=true;for(var x=0;x<roles.length;x++){r+=(first?"":",")
+XMLHelper.getElementData(roles[x],"role");first=false;}
CommonContext.roles=r;EventDispatcher.dispatchEvent(Authenticator.events.authorizationComplete);});}}}
var Bootstraper={functions:[],add:function(callback){Bootstraper.functions.push(callback);},go:function(){for(var x=0;x<Bootstraper.functions.length;x++){if(typeof(Bootstraper.functions[x])=='function'){Bootstraper.functions[x]();}}}}
var CommonContext={user:null,udcid:null,pidm:null,roles:"",udcIdentity:null,locale:"fr",standalone:false};var ChannelManager={commtype:"hash",channels:[],supportedChannels:["hash","xdm","standalone"],supportsXDM:false,initialize:function(){if(window.postMessage){ChannelManager.commtype="xdm";ChannelManager.supportsXDM=true;if(window.addEventListener){window.addEventListener('message',function(e){MessageProcessor.processMessage(e.data)},false);}else{window.attachEvent('onmessage',function(e){MessageProcessor.processMessage(e.data)},false);}}else{ChannelManager.commtype="hash";}},addChannel:function(name,channel){this.channels[name]=channel;},send:function(message,destination){switch(this.commtype){case"hash":if(typeof(message)!="string"){message=Messenger.xml2string(message);}
$('#'+destination).attr('src',this.channels[destination]+'#'
+Messenger.encode(message));break;case"standalone":Messenger.messageHandler(message);break;case"xdm":this.sendCrossDocumentMessage(message,destination);break;default:ErrorManager.show("No communication method has been defined.");break;}},sendCrossDocumentMessage:function(message,destination){var win=document.getElementById(destination).contentWindow;win.postMessage(message,"*");}};var MessageProcessor={checkForHelpMessage:function(xmldoc){var processed=false;$(xmldoc).find('help').find('url').each(function(i){HelpManager.showHelpByURL($(this).text());processed=true;});return processed;},checkForErrorMessage:function(xmldoc){var codes=[];var messages=[];var processed=false;$(xmldoc).find('errors').find('error').each(function(i){codes[i]=$(this).find('code').text();messages[i]=$(this).find('message').text();processed=true;});var out="";if(processed&&messages.length>0){var statusMessageArr=[];$(messages).each(function(i){msg=messages[i];if(codes[i]){msg+=" ("+codes[i]+")";}
out+="<span class='errorMessage'>"+msg+"</span>";});var buttons=[Button("errorOkButton","common_ok",ModalWindowFactory.close,"blue")];ModalWindowFactory.show("errorWindowModal","errorwindow_label_title","blue",$(out),"errorWindowContent",buttons,null);codes=[];messages=[];}
return processed;},checkForRequestMessage:function(xmldoc){var processed=false;if($(xmldoc).find('request').length>0){var req=$(xmldoc).find('request').text();var activeFrameName=null;var app=null;if($("li.activeOpenItem").length>0){activeFrameName=$("li.activeOpenItem").attr("id").replace(OpenItems.openItemMarker,"");app=OpenItems.findAnyOpenItemByName(activeFrameName);}
switch(req){case"navigate":ChannelManager.send(createApplicationPageNavigationMessage(app.context.pageName),activeFrameName);break;case"context":if(CommonContext.standalone){if(typeof(Messenger.messageHandler)=='function'){Messenger.messageHandler(createContextMessage({pageName:CommonPlatform.defaultPageName}));}}else{ChannelManager.send(createContextMessage(app.context),activeFrameName);}
break;default:break;}
processed=true;}
return processed;},checkForConfirmationMessage:function(xmldoc){var processed=false;if(xmldoc.getElementsByTagName('confirmation').length>0){var message=XMLHelper.getElementData(xmldoc.getElementsByTagName('confirmation')[0],"message");var title=XMLHelper.getElementData(xmldoc.getElementsByTagName('confirmation')[0],"title");var responses=xmldoc.getElementsByTagName('confirmation')[0].getElementsByTagName('response');var buttons=[];var confirmationResponseSuffix="_responseSelected";for(var x=0;x<responses.length;x++){buttons.push(Button(responses[x].getAttribute("responseValue")
+confirmationResponseSuffix,responses[x].getAttribute("label"),function(){MessageProcessor.sendConfirmationResponse($(this).attr("id").replace(confirmationResponseSuffix,""));ModalWindowFactory.close();},"blue"));}
ModalWindowFactory.show("confirmationWindowModal","confirmation_label_title","blue",message,"",buttons,null);processed=true;}
return processed;},checkForStatusMessage:function(xmldoc){var processed=false;$(xmldoc).find('status').find('message').each(function(i){processed=true;});return processed;},checkForUdcIdentityMessage:function(xmldoc){var processed=false;if(!xmldoc||!xmldoc.getElementsByTagName('UDCIdentity')[0]){return processed;}
processed=true;CommonContext.udcIdentity=xmldoc;CommonContext.udcid=XMLHelper.getElementData(xmldoc,"UDCIdentifier");return processed;},checkForOpenItemMessage:function(xmldoc){var processed=false;if(!xmldoc||!xmldoc.getElementsByTagName('context')[0]){return false;}
var appid=XMLHelper.getElementData(xmldoc.getElementsByTagName('context')[0],"appid");if($(xmldoc).find('openitem').length>0){var action=XMLHelper.getElementData(xmldoc.getElementsByTagName('openitem')[0],"action");var page=XMLHelper.getElementData(xmldoc.getElementsByTagName('openitem')[0],"page");switch(action){case"open":OpenItems.addApplicationPage(appid,page);break;case"close":OpenItems.removeApplicationPage(appid,page);break;default:break;}
processed=true;}
return processed;},checkForNavigationMessage:function(xmldoc){var processed=false;if(xmldoc.getElementsByTagName('navigate').length>0){var message=XMLHelper.getElementData(xmldoc.getElementsByTagName('navigate')[0],"location");if(message){Navigation.navigate(message,null);}
processed=true;}
return processed;},checkForUdcIdMessage:function(xmldoc){var processed=false;if(xmldoc.getElementsByTagName('udcIdentity').length>0){getUDCXml(XMLHelper.getElementData(xmldoc,"identity"));processed=true;}
return processed;},sendConfirmationResponse:function(response){if(CommonContext.standalone){if(typeof(Messenger.messageHandler)=='function'){Messenger.messageHandler(createConfirmationResponseMessage(response));}}else{if($("li.activeOpenItem").length>0){var activeFrameName=$("li.activeOpenItem").attr("id").replace(OpenItems.openItemMarker,"");ChannelManager.send(createConfirmationResponseMessage(response),activeFrameName);}}},checkForServiceCallMessage:function(message){var processed=false;if(message.firstChild.childNodes.length>0&&message.firstChild.childNodes[0].nodeName=="service"){function callback(response){var activeFrameName=null;var xmlString=(new XMLSerializer()).serializeToString(response);ChannelManager.send(xmlString,activeFrameName);}
alert("service call progress")
ServiceManager.get($(message).find('url').text(),callback);processed=true;}
return processed;},processMessage:function(message){message=Messenger.decode(message);xmldoc=Messenger.string2xml(message);if(this.checkForHelpMessage(xmldoc)||this.checkForErrorMessage(xmldoc)||this.checkForStatusMessage(xmldoc)||this.checkForConfirmationMessage(xmldoc)||this.checkForNavigationMessage(xmldoc)||this.checkForRequestMessage(xmldoc)||this.checkForOpenItemMessage(xmldoc)||this.checkForUdcIdentityMessage(xmldoc)||this.checkForUdcIdMessage(xmldoc)||this.checkForServiceCallMessage(xmldoc)){alert(message)
return;}else{this.broadcast(message);}},broadcast:function(message){$('#content > iframe').each(function(i){ChannelManager.send(message,$(this).attr("name"));});if(typeof(messageHandler)=='function'){messageHandler(message);}}};var ServiceManager={get:function(url,callback){this.ajax("GET",url,null,callback);},put:function(url,data,callback){this.ajax("PUT",url,data,callback);},post:function(url,data,callback){this.ajax("POST",url,data,callback);},remove:function(url,data,callback){this.ajax("DELETE",url,data,callback);},ajax:function(httpMethod,url,data,callback){var xmlhttp=null;if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest();}else if(window.ActiveXObject){xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");}
if(xmlhttp!=null){xmlhttp.onreadystatechange=stateChange;xmlhttp.open(httpMethod,url,true);xmlhttp.send(data);}else{ErrorManager.show("Your browser does not support XMLHTTP.");}
function stateChange(){if(xmlhttp.readyState==4){if(xmlhttp.status==200){if(callback&&typeof(callback)==="function"){if(xmlhttp.responseXML){callback(xmlhttp.responseXML);}else{callback(xmlhttp.responseText);}}}else{if(callback&&typeof(callback)==="function"){callback(xmlhttp);}}}}}}
var FragmentManager={handlers:[],currentFragment:"",pollIntervalId:null,initialize:function(){FragmentManager.addHandler(handleFragment);function handleFragment(frag){if(frag.indexOf("/")!==-1){var cuip=frag.substring(frag.lastIndexOf("/")+1);if(cuip.length>4&&cuip.substring(0,4)===ContentManager.commonUIPlatformMarker){frag=frag.substring(0,frag.lastIndexOf("/"));var nav=Navigation.findNavigationEntry(frag);if(!nav){return;}
var name=nav.name+"_"+cuip;if(OpenItems.isOpen(name)){ContentManager.bringToFront(name);}else{var anyApp=OpenItems.findAnyOpenItemByName(name);if(anyApp instanceof OpenItemValueObject){ContentManager.bringToFront(anyApp.navigationEntry.name);}else{var context=new ContextValueObject()
if(nav.page&&nav.page!==""){context.pageName=nav.page;}
Navigation.navigate(frag,null);}}}else{var nav=Navigation.findNavigationEntry(frag);if(!nav){return;}
var context=new ContextValueObject()
if(nav.page&&nav.page!==""){context.pageName=nav.page;}
Navigation.navigate(nav,context);}}}},startPolling:function(){if(FragmentManager.pollIntervalId){return;}
FragmentManager.pollIntervalId=setInterval(FragmentManager.poll,250);},stopPolling:function(){if(FragmentManager.pollIntervalId){clearInterval(FragmentManager.pollIntervalId);}},addHandler:function(callback){if(callback&&typeof(callback)==='function'){FragmentManager.handlers.push(callback);FragmentManager.startPolling();}},poll:function(){var frag=FragmentManager.get();if(frag){frag=FragmentManager.sanitize(frag);if(frag==FragmentManager.currentFragment){return;}else{for(var x=0;x<FragmentManager.handlers.length;x++){if(typeof(FragmentManager.handlers[x])==='function'){FragmentManager.handlers[x](frag);}}}}},sanitize:function(frag){frag=frag.replace(/\%20/g," ");return frag;},set:function(fragment){if(fragment===FragmentManager.currentFragment){return;}else{FragmentManager.currentFragment=fragment;}
var frag=window.location.hash;if(frag){frag=frag.substr(1);if(frag===fragment){return;}else{window.location.hash=fragment;}}else{window.location.hash=fragment;}},get:function(){var frag=window.location.hash;if(frag){return frag.substr(1);}
return null;}};var Localization={events:{localeChange:"localeChange"},defaultLocale:"en",initialize:function(){var locale=CookieManager.get("locale");locale="en";if(locale){CommonContext.locale=locale;}else{CommonContext.locale=Localization.defaultLocale;}
Localization.setLocale(CommonContext.locale);},setLocale:function(locale){CommonContext.locale=locale;ResourceManager.setLocale(locale);var direction="ltr";if(locale.substr(0,2)=="ar"){direction="rtl";}
Localization.setLangDirection(direction);},setLangDirection:function(direction){if(direction=="ltr"||direction=="rtl"){if(Localization.getLangDirection()!=direction){$('html').css("direction",direction);Localization.loadStyles();}}},getLangDirection:function(){if(!$('html').css("direction")){return"ltr";}
return $('html').css("direction");},toggleFloatDirection:function(){$('*:not(#prefWindow > div):not(#errorWindow > div)').each(function(i){if($(this).css("float")){if($(this).css("float")=="right"){$(this).css("float","left");}else if($(this).css("float")=="left"){$(this).css("float","right");}}});},loadStyles:function(){if(typeof cssFiles=='undefined'||cssFiles.length==0){var dom=document.styleSheets;var len=dom.length;for(var i=0;i<len;i++){StylesheetFormatter.toggle(i);}}else{for(var i=0;i<cssFiles.length;i++){StylesheetFormatter.toggle(cssFiles[i]);}}},toggleDirection:function(){var exceptions=['prefwindow','errorwindow','.browsebutton div','.browsebutton div div','.htmlbutton','.menu','.menu div','.menusmall div'];var dom=document.styleSheets;var len=dom.length;for(var i=0;i<len;i++){var css;if(jQuery.browser.msie){css=dom[i].rules;}else{css=dom[i].cssRules;}
var clen=css.length;for(var j=0;j<clen;j++){if(css[j].style){var style=css[j].style;var selector=css[j].selectorText;if($.inArray(selector.toLowerCase(),exceptions)==-1){if(jQuery.browser.msie){if(style.styleFloat){if(style.styleFloat=='left'){style.styleFloat='right';}else if(style.styleFloat=='right'){style.styleFloat='left';}}}else{if(style.cssFloat){if(style.cssFloat=='left'){style.cssFloat='right';}else if(style.cssFloat=='right'){style.cssFloat='left';}}}
var ml=style.marginLeft;var mr=style.marginRight;style.marginLeft='';style.marginRight='';if(ml)
style.marginRight=ml;if(mr)
style.marginLeft=mr;var pl=style.paddingLeft;var pr=style.paddingRight;style.paddingLeft=null;style.paddingRight=null;if(pl)
style.paddingRight=pl;if(pr)
style.paddingLeft=pr;var l=style.left;var r=style.right;style.left='';style.right='';if(l!=''){style.right=l;}
if(r!=''){style.left=r;}
var ta=style.textAlign;if(ta=='left'){style.textAlign='right';}else if(ta=='right'){style.textAlign='left';}
var bl=style.borderLeft;var br=style.borderRight;style.borderLeft='';style.borderRight='';if(bl){style.borderRight=bl;}
if(br){style.borderLeft=br;}}}}}}};var HelpManager={visisble:false,initialize:function(){var out=$(""
+"<div id='helpWindow'>"
+"<div id='helpWindowControls'>"
+"<span id='helpWindowIcon'></span>"
+"<span id='helpWindowTitle'></span>"
+"<span id='helpWindowCloseButton'></span>"
+"</div>"
+"<div id='helpWindowTop'></div>"
+"<div id='helpWindowMiddle'>"
+"<iframe id='helpWindowContent' frameborder='no'></iframe>"
+"</div>"
+"<div id='helpWindowBottom'></div>"
+"<span id='helpWindowTab'><span id='helpWindowTabText'></span></span>"
+"</div>");EventDispatcher.addEventListener(Localization.events.localeChange,function(){out.find('#helpWindowTitle, #helpWindowTab > #helpWindowTabText').text(ResourceManager.getString("userdetails_help"));});$('body').append(out);$('#helpWindowCloseButton').click(function(){HelpManager.close();});$('.helpText').bind("click",function(){EventDispatcher.dispatchEvent('displayHelp');});$('#helpWindowTab').bind("click",function(){if(HelpManager.visisble){HelpManager.toggle();}else{getHelp();}});EventDispatcher.addEventListener('displayHelp',function(){if(CommonContext.standalone){if(typeof(Messenger.messageHandler)=='function'){Messenger.messageHandler(createRequestMessage("help"));}}else{if($("li.activeOpenItem").length>0){var activeFrameName=$("li.activeOpenItem").attr("id").replace(OpenItems.openItemMarker,"");ChannelManager.send(createRequestMessage("help"),activeFrameName);}}});},close:function(){$('#helpWindow').animate({top:-344},500);HelpManager.visisble=false;$('#helpWindowCloseButton').removeClass("open");$('#helpWindowCloseButton').addClass("closed");$('#helpWindow').draggable("disable");},showHelpByURL:function(url){$('#helpWindowContent').attr("src",url);HelpManager.showHelpWindow();},showHelpWindow:function(){$('#helpWindow').animate({top:-3},500);HelpManager.visisble=true;$('#helpWindowCloseButton').removeClass("closed");$('#helpWindowCloseButton').addClass("open");$('#helpWindow').draggable({iframeFix:'true',containment:'document'});},toggle:function(){if(helpWindowVisible){HelpManager.close();}else{HelpManager.show();}}}
var ResourceManager={bundles:[],defaultResourceBundle:"common-platform",endpoint:"/js/locale",locale:null,addResourceBundle:function(bundle){if(bundle&&typeof(bundle)=='string'){if(!ResourceManager.locale){ResourceManager.bundles.push(new ResourceBundle(bundle,null,null));return;}
$.ajax({url:ResourceManager.endpoint+'/'
+ResourceManager.locale+'/'+bundle
+'.xml',type:'GET',error:function(xmldoc){ServiceManager.get(ResourceManager.endpoint
+'/'
+ResourceManager.locale.substr(0,2)+'/'
+bundle+'.xml',function(xmldoc){if(!xmldoc){return;}
var resources=xmldoc.getElementsByTagName("Resource");var vo=[];for(var x=0;x<resources.length;x++){if(!resources[x].attributes){continue;}
var res=new Resource();for(var y=0;y<resources[x].attributes.length;y++){res[resources[x].attributes[y].nodeName]=resources[x].attributes[y].nodeValue;}
if(!res.key||!res.value){continue;}
vo.push(res);}
ResourceManager.bundles.push(new ResourceBundle(bundle,vo,ResourceManager.locale));EventDispatcher.dispatchEvent(Localization.events.localeChange);});},success:function(xmldoc){if(!xmldoc){return;}
var resources=xmldoc.getElementsByTagName("Resource");var vo=[];for(var x=0;x<resources.length;x++){if(!resources[x].attributes){continue;}
var res=new Resource();for(var y=0;y<resources[x].attributes.length;y++){res[resources[x].attributes[y].nodeName]=resources[x].attributes[y].nodeValue;}
if(!res.key||!res.value){continue;}
vo.push(res);}
ResourceManager.bundles.push(new ResourceBundle(bundle,vo,ResourceManager.locale));EventDispatcher.dispatchEvent(Localization.events.localeChange);}});}},getString:function(bundle,key){if(!key){key=bundle;bundle=ResourceManager.defaultResourceBundle;}
for(var x=0;x<ResourceManager.bundles.length;x++){var rb=ResourceManager.bundles[x];if(rb.name==bundle&&rb.content){for(var y=0;y<rb.content.length;y++){if(rb.content[y].key==key){return rb.content[y].value;}}}}},removeResourceBundle:function(name){for(var x=0;x<ResourceManager.bundles.length;x++){if(ResourceManager.bundles[x].name==name){ResourceManager.bundles.splice(x,1);}}},setLocale:function(locale){ResourceManager.locale=locale;for(var x=0;x<ResourceManager.bundles.length;x++){var n=ResourceManager.bundles[x].name;ResourceManager.removeResourceBundle(n);ResourceManager.addResourceBundle(n);}}}
function ResourceBundle(name,content,locale){this.name=name;this.content=content;this.locale=locale;}
function Resource(key,value){this.key=key;this.value=value;}